rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if the user owns this resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Check if the document belongs to the current user
    function isDocumentOwner() {
      return isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // Check if creating a document with own userId
    function isCreatingOwnDocument() {
      return isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }

    // ============================================
    // USERS COLLECTION
    // ============================================
    // Users can only read/write their own user document

    match /users/{userId} {
      // Users can read their own profile
      allow read: if isOwner(userId);

      // Users can create their own profile (during signup)
      allow create: if isOwner(userId);

      // Users can update their own profile
      allow update: if isOwner(userId);

      // Users cannot delete their profile (admin only)
      allow delete: if false;
    }

    // ============================================
    // PROJECTS COLLECTION
    // ============================================
    // Users can only access their own projects

    match /projects/{projectId} {
      // Users can read their own projects
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Users can create projects for themselves
      allow create: if isCreatingOwnDocument();

      // Users can update their own projects
      allow update: if isDocumentOwner();

      // Users can delete their own projects
      allow delete: if isDocumentOwner();
    }

    // ============================================
    // COMMUNITY AGENTS COLLECTION
    // ============================================
    // Public read, authenticated write with ownership rules

    match /communityAgents/{agentId} {
      // Anyone authenticated can read community agents
      allow read: if isAuthenticated();

      // Authenticated users can upload new agents
      allow create: if isAuthenticated()
        && request.resource.data.uploadedById == request.auth.uid
        && request.resource.data.isActive == true;

      // Only the uploader can update their agents
      // But anyone can update vote counts (handled via increment)
      allow update: if isAuthenticated() && (
        // Owner can update anything
        resource.data.uploadedById == request.auth.uid
        // Or anyone can update votes (for voting functionality)
        || (
          request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['upvotes', 'downvotes', 'userVotes', 'downloadCount'])
        )
      );

      // Only the uploader can delete their agents
      allow delete: if isAuthenticated()
        && resource.data.uploadedById == request.auth.uid;
    }

    // ============================================
    // DEFAULT DENY
    // ============================================
    // Deny access to any other collections

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
